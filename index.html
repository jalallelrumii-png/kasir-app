<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4F46E5">
    <meta name="description" content="Aplikasi Kasir dan Stok Barang">
    <link rel="manifest" href="manifest.json">
    <title>Kasir & Stok Barang</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #4F46E5;
            --primary-dark: #4338CA;
            --success: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --dark: #1F2937;
            --light: #F3F4F6;
            --white: #FFFFFF;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--light);
            color: var(--dark);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: var(--primary);
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* Navigation */
        .nav-tabs {
            background: white;
            border-radius: 10px;
            padding: 10px;
            margin: 20px 0;
            display: flex;
            gap: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .nav-tab {
            padding: 12px 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            color: var(--dark);
            transition: all 0.3s;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: var(--light);
        }

        .nav-tab.active {
            background: var(--primary);
            color: white;
        }

        /* Content Sections */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .card-header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light);
        }

        /* Dashboard Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
        }

        .stat-card.success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, var(--warning) 0%, #D97706 100%);
        }

        .stat-card.danger {
            background: linear-gradient(135deg, var(--danger) 0%, #DC2626 100%);
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
        }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--light);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #DC2626;
        }

        .btn-secondary {
            background: var(--light);
            color: var(--dark);
        }

        .btn-secondary:hover {
            background: #E5E7EB;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--light);
        }

        th {
            background: var(--light);
            font-weight: 600;
            color: var(--dark);
        }

        tr:hover {
            background: #F9FAFB;
        }

        /* POS Layout */
        .pos-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .product-item {
            background: white;
            border: 2px solid var(--light);
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .product-item:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .product-item.low-stock {
            border-color: var(--danger);
            background: #FEF2F2;
        }

        .product-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .product-price {
            color: var(--primary);
            font-weight: bold;
            font-size: 18px;
        }

        .product-stock {
            font-size: 12px;
            color: #6B7280;
            margin-top: 5px;
        }

        /* Cart */
        .cart-container {
            position: sticky;
            top: 100px;
        }

        .cart-items {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--light);
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .qty-control {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .qty-btn {
            width: 30px;
            height: 30px;
            border: none;
            background: var(--primary);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
        }

        .qty-btn:hover {
            background: var(--primary-dark);
        }

        .cart-total {
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .total-row.grand-total {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            padding-top: 10px;
            border-top: 2px solid var(--dark);
        }

        /* Search */
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 12px;
            border: 2px solid var(--light);
            border-radius: 8px;
            font-size: 16px;
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #9CA3AF;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        /* Badge */
        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #D1FAE5;
            color: #065F46;
        }

        .badge-warning {
            background: #FEF3C7;
            color: #92400E;
        }

        .badge-danger {
            background: #FEE2E2;
            color: #991B1B;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .pos-grid {
                grid-template-columns: 1fr;
            }

            .cart-container {
                position: static;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .product-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }

            .nav-tabs {
                flex-wrap: wrap;
            }
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid var(--light);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 2000;
            display: none;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.show {
            display: flex;
        }

        .notification.success {
            border-left: 4px solid var(--success);
        }

        .notification.error {
            border-left: 4px solid var(--danger);
        }

        /* Print Styles */
        @media print {
            body * {
                visibility: hidden;
            }
            .print-area, .print-area * {
                visibility: visible;
            }
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="logo">
                üè™ Kasir & Stok Barang
            </div>
            <div class="user-info">
                <span id="onlineStatus" style="padding: 5px 10px; border-radius: 5px; font-size: 12px; background: #10B981; color: white;">üü¢ Online</span>
                <span id="currentDate"></span>
                <button class="btn btn-secondary" onclick="exportData()">üì• Export</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="showSection('pos')">üõí Kasir</button>
            <button class="nav-tab" onclick="showSection('products')">üì¶ Produk</button>
            <button class="nav-tab" onclick="showSection('transactions')">üí∞ Transaksi</button>
            <button class="nav-tab" onclick="showSection('reports')">üìà Laporan</button>
            <button class="nav-tab" onclick="showSection('settings')">‚öôÔ∏è Pengaturan</button>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="content-section active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Produk</div>
                    <div class="stat-value" id="totalProducts">0</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-label">Penjualan Hari Ini</div>
                    <div class="stat-value" id="todaySales">Rp 0</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-label">Stok Menipis</div>
                    <div class="stat-value" id="lowStock">0</div>
                </div>
                <div class="stat-card danger">
                    <div class="stat-label">Total Transaksi</div>
                    <div class="stat-value" id="totalTransactions">0</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Transaksi Terakhir</div>
                <div class="table-container">
                    <table id="recentTransactionsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Tanggal</th>
                                <th>Total</th>
                                <th>Items</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- POS Section -->
        <div id="pos" class="content-section">
            <div class="pos-grid">
                <div>
                    <div class="card">
                        <div class="search-box">
                            <input type="text" id="productSearch" placeholder="Cari produk..." oninput="filterProducts()">
                            <span class="search-icon">üîç</span>
                        </div>
                        <div id="productList" class="product-grid"></div>
                    </div>
                </div>

                <div class="cart-container">
                    <div class="card">
                        <div class="card-header">Keranjang Belanja</div>
                        <div id="cartItems" class="cart-items"></div>
                        
                        <div class="cart-total">
                            <div class="total-row">
                                <span>Subtotal:</span>
                                <span id="cartSubtotal">Rp 0</span>
                            </div>
                            <div class="total-row">
                                <span>Diskon:</span>
                                <input type="number" id="discountInput" value="0" min="0" 
                                       style="width: 100px; text-align: right;" onchange="updateCart()">
                            </div>
                            <div class="total-row grand-total">
                                <span>Total:</span>
                                <span id="cartTotal">Rp 0</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Uang Dibayar</label>
                            <input type="number" id="paymentInput" class="form-control" min="0" oninput="calculateChange()">
                        </div>

                        <div class="form-group">
                            <label>Kembalian</label>
                            <input type="text" id="changeOutput" class="form-control" readonly>
                        </div>

                        <button class="btn btn-success" style="width: 100%; margin-bottom: 10px;" onclick="processTransaction()">
                            üí≥ Proses Pembayaran
                        </button>
                        <button class="btn btn-danger" style="width: 100%;" onclick="clearCart()">
                            üóëÔ∏è Bersihkan Keranjang
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Products Section -->
        <div id="products" class="content-section">
            <div class="card">
                <div class="card-header">
                    Manajemen Produk
                    <button class="btn btn-primary" style="float: right;" onclick="openProductModal()">
                        ‚ûï Tambah Produk
                    </button>
                </div>

                <div class="search-box">
                    <input type="text" id="productSearchTable" placeholder="Cari produk..." oninput="filterProductTable()">
                    <span class="search-icon">üîç</span>
                </div>

                <div class="table-container">
                    <table id="productsTable">
                        <thead>
                            <tr>
                                <th>Kode</th>
                                <th>Nama</th>
                                <th>Kategori</th>
                                <th>Harga</th>
                                <th>Stok</th>
                                <th>Status</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Transactions Section -->
        <div id="transactions" class="content-section">
            <div class="card">
                <div class="card-header">Riwayat Transaksi</div>

                <div class="form-grid" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label>Dari Tanggal</label>
                        <input type="date" id="filterDateFrom" class="form-control" onchange="filterTransactions()">
                    </div>
                    <div class="form-group">
                        <label>Sampai Tanggal</label>
                        <input type="date" id="filterDateTo" class="form-control" onchange="filterTransactions()">
                    </div>
                </div>

                <div class="table-container">
                    <table id="transactionsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Tanggal</th>
                                <th>Total</th>
                                <th>Diskon</th>
                                <th>Bayar</th>
                                <th>Kembali</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Reports Section -->
        <div id="reports" class="content-section">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Penjualan Bulan Ini</div>
                    <div class="stat-value" id="monthSales">Rp 0</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-label">Total Penjualan</div>
                    <div class="stat-value" id="totalSales">Rp 0</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-label">Produk Terlaris</div>
                    <div class="stat-value" id="topProduct">-</div>
                </div>
                <div class="stat-card danger">
                    <div class="stat-label">Nilai Stok</div>
                    <div class="stat-value" id="stockValue">Rp 0</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Produk Terlaris</div>
                <div class="table-container">
                    <table id="topProductsTable">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Produk</th>
                                <th>Terjual</th>
                                <th>Total Penjualan</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settings" class="content-section">
            <div class="card">
                <div class="card-header">Pengaturan Toko</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nama Toko</label>
                        <input type="text" id="storeName" class="form-control" value="Toko Saya">
                    </div>
                    <div class="form-group">
                        <label>Alamat</label>
                        <input type="text" id="storeAddress" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Telepon</label>
                        <input type="tel" id="storePhone" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="storeEmail" class="form-control">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="saveSettings()">üíæ Simpan Pengaturan</button>
            </div>

            <div class="card">
                <div class="card-header">Data Management</div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="exportData()">üì• Export Data</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">
                        üì§ Import Data
                    </button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                    <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Hapus Semua Data</button>
                    <button class="btn btn-success" onclick="loadSampleData()">üì¶ Muat Data Contoh</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="modalTitle">Tambah Produk</span>
            </div>
            <form id="productForm">
                <div class="form-group">
                    <label>Kode Produk</label>
                    <input type="text" id="productCode" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Nama Produk</label>
                    <input type="text" id="productName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Kategori</label>
                    <input type="text" id="productCategory" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Harga</label>
                    <input type="number" id="productPrice" class="form-control" min="0" required>
                </div>
                <div class="form-group">
                    <label>Stok</label>
                    <input type="number" id="productStock" class="form-control" min="0" required>
                </div>
                <div class="form-group">
                    <label>Minimal Stok</label>
                    <input type="number" id="productMinStock" class="form-control" min="0" value="5">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-primary">üíæ Simpan</button>
                    <button type="button" class="btn btn-secondary" onclick="closeProductModal()">‚ùå Batal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Transaction Detail Modal -->
    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Detail Transaksi</div>
            <div id="transactionDetail"></div>
            <button class="btn btn-secondary" onclick="closeTransactionModal()">Tutup</button>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification">
        <span id="notificationText"></span>
    </div>

    <!-- Print Area -->
    <div id="printArea" class="print-area" style="display: none;"></div>

    <script>
        // Data Storage
        let products = JSON.parse(localStorage.getItem('products')) || [];
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let cart = [];
        let editingProductId = null;
        let settings = JSON.parse(localStorage.getItem('settings')) || {
            storeName: 'Toko Saya',
            storeAddress: '',
            storePhone: '',
            storeEmail: ''
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateDashboard();
            renderProducts();
            renderProductsTable();
            renderTransactions();
            updateReports();
            loadSettings();
            updateDateTime();
            setInterval(updateDateTime, 1000);

            // Set default date filters
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('filterDateFrom').value = today;
            document.getElementById('filterDateTo').value = today;

            // Register Service Worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => {
                        console.log('Service Worker registered successfully');
                        showNotification('Aplikasi siap digunakan offline!', 'success');
                    })
                    .catch(err => console.log('SW Error:', err));
            }

            // Install prompt
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                // Show install button after 3 seconds
                setTimeout(() => {
                    if (confirm('Install aplikasi ini agar bisa digunakan offline?')) {
                        deferredPrompt.prompt();
                        deferredPrompt.userChoice.then((choiceResult) => {
                            if (choiceResult.outcome === 'accepted') {
                                showNotification('Aplikasi berhasil diinstall!', 'success');
                            }
                            deferredPrompt = null;
                        });
                    }
                }, 3000);
            });

            // Monitor online/offline status
            updateOnlineStatus();
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
        });

        function updateOnlineStatus() {
            const statusEl = document.getElementById('onlineStatus');
            if (navigator.onLine) {
                statusEl.innerHTML = 'üü¢ Online';
                statusEl.style.background = '#10B981';
            } else {
                statusEl.innerHTML = 'üî¥ Offline';
                statusEl.style.background = '#EF4444';
                showNotification('Mode Offline - Data tersimpan lokal', 'error');
            }
        }

        // Navigation
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');

            if (sectionId === 'reports') {
                updateReports();
            }
        }

        // Update Date Time
        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('id-ID', options);
        }

        // Products Management
        function renderProducts() {
            const productList = document.getElementById('productList');
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            
            const filtered = products.filter(p => 
                p.name.toLowerCase().includes(searchTerm) || 
                p.code.toLowerCase().includes(searchTerm)
            );

            productList.innerHTML = filtered.map(product => `
                <div class="product-item ${product.stock <= product.minStock ? 'low-stock' : ''}" 
                     onclick="addToCart('${product.id}')">
                    <div class="product-name">${product.name}</div>
                    <div class="product-price">Rp ${formatNumber(product.price)}</div>
                    <div class="product-stock">Stok: ${product.stock}</div>
                </div>
            `).join('');
        }

        function renderProductsTable() {
            const tbody = document.querySelector('#productsTable tbody');
            const searchTerm = document.getElementById('productSearchTable')?.value.toLowerCase() || '';
            
            const filtered = products.filter(p => 
                p.name.toLowerCase().includes(searchTerm) || 
                p.code.toLowerCase().includes(searchTerm) ||
                p.category.toLowerCase().includes(searchTerm)
            );

            tbody.innerHTML = filtered.map(product => {
                const stockStatus = product.stock <= product.minStock ? 
                    '<span class="badge badge-danger">Stok Menipis</span>' : 
                    '<span class="badge badge-success">Normal</span>';
                
                return `
                    <tr>
                        <td>${product.code}</td>
                        <td>${product.name}</td>
                        <td>${product.category}</td>
                        <td>Rp ${formatNumber(product.price)}</td>
                        <td>${product.stock}</td>
                        <td>${stockStatus}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="editProduct('${product.id}')">‚úèÔ∏è</button>
                            <button class="btn btn-danger" onclick="deleteProduct('${product.id}')">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterProducts() {
            renderProducts();
        }

        function filterProductTable() {
            renderProductsTable();
        }

        function openProductModal() {
            editingProductId = null;
            document.getElementById('modalTitle').textContent = 'Tambah Produk';
            document.getElementById('productForm').reset();
            document.getElementById('productModal').classList.add('active');
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.remove('active');
            editingProductId = null;
        }

        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            editingProductId = id;
            document.getElementById('modalTitle').textContent = 'Edit Produk';
            document.getElementById('productCode').value = product.code;
            document.getElementById('productName').value = product.name;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productStock').value = product.stock;
            document.getElementById('productMinStock').value = product.minStock;
            document.getElementById('productModal').classList.add('active');
        }

        function deleteProduct(id) {
            if (!confirm('Yakin ingin menghapus produk ini?')) return;
            
            products = products.filter(p => p.id !== id);
            saveProducts();
            renderProducts();
            renderProductsTable();
            updateDashboard();
            showNotification('Produk berhasil dihapus', 'success');
        }

        document.getElementById('productForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const productData = {
                code: document.getElementById('productCode').value,
                name: document.getElementById('productName').value,
                category: document.getElementById('productCategory').value,
                price: parseFloat(document.getElementById('productPrice').value),
                stock: parseInt(document.getElementById('productStock').value),
                minStock: parseInt(document.getElementById('productMinStock').value)
            };

            if (editingProductId) {
                const index = products.findIndex(p => p.id === editingProductId);
                products[index] = { ...products[index], ...productData };
                showNotification('Produk berhasil diupdate', 'success');
            } else {
                products.push({
                    id: Date.now().toString(),
                    ...productData,
                    createdAt: new Date().toISOString()
                });
                showNotification('Produk berhasil ditambahkan', 'success');
            }

            saveProducts();
            renderProducts();
            renderProductsTable();
            updateDashboard();
            closeProductModal();
        });

        // Cart Management
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            if (product.stock <= 0) {
                showNotification('Stok produk habis!', 'error');
                return;
            }

            const cartItem = cart.find(item => item.id === productId);
            if (cartItem) {
                if (cartItem.quantity >= product.stock) {
                    showNotification('Stok tidak mencukupi!', 'error');
                    return;
                }
                cartItem.quantity++;
            } else {
                cart.push({
                    id: productId,
                    name: product.name,
                    price: product.price,
                    quantity: 1,
                    stock: product.stock
                });
            }

            updateCart();
            showNotification(`${product.name} ditambahkan ke keranjang`, 'success');
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            updateCart();
        }

        function updateQuantity(productId, change) {
            const cartItem = cart.find(item => item.id === productId);
            if (!cartItem) return;

            const product = products.find(p => p.id === productId);
            cartItem.quantity += change;

            if (cartItem.quantity <= 0) {
                removeFromCart(productId);
            } else if (cartItem.quantity > product.stock) {
                cartItem.quantity = product.stock;
                showNotification('Stok tidak mencukupi!', 'error');
            }

            updateCart();
        }

        function updateCart() {
            const cartItems = document.getElementById('cartItems');
            const discount = parseFloat(document.getElementById('discountInput').value) || 0;

            if (cart.length === 0) {
                cartItems.innerHTML = '<p style="text-align: center; color: #9CA3AF; padding: 20px;">Keranjang kosong</p>';
                document.getElementById('cartSubtotal').textContent = 'Rp 0';
                document.getElementById('cartTotal').textContent = 'Rp 0';
                return;
            }

            cartItems.innerHTML = cart.map(item => `
                <div class="cart-item">
                    <div class="cart-item-info">
                        <div style="font-weight: 600;">${item.name}</div>
                        <div style="color: #6B7280;">Rp ${formatNumber(item.price)} x ${item.quantity}</div>
                    </div>
                    <div class="cart-item-actions">
                        <div class="qty-control">
                            <button class="qty-btn" onclick="updateQuantity('${item.id}', -1)">-</button>
                            <span style="width: 30px; text-align: center;">${item.quantity}</span>
                            <button class="qty-btn" onclick="updateQuantity('${item.id}', 1)">+</button>
                        </div>
                        <button class="btn btn-danger" onclick="removeFromCart('${item.id}')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');

            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const total = subtotal - discount;

            document.getElementById('cartSubtotal').textContent = 'Rp ' + formatNumber(subtotal);
            document.getElementById('cartTotal').textContent = 'Rp ' + formatNumber(total);

            calculateChange();
        }

        function calculateChange() {
            const discount = parseFloat(document.getElementById('discountInput').value) || 0;
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const total = subtotal - discount;
            const payment = parseFloat(document.getElementById('paymentInput').value) || 0;
            const change = payment - total;

            document.getElementById('changeOutput').value = change >= 0 ? 'Rp ' + formatNumber(change) : 'Rp 0';
        }

        function clearCart() {
            if (cart.length === 0) return;
            if (!confirm('Yakin ingin mengosongkan keranjang?')) return;
            
            cart = [];
            updateCart();
            document.getElementById('paymentInput').value = '';
            document.getElementById('changeOutput').value = '';
            document.getElementById('discountInput').value = '0';
            showNotification('Keranjang dikosongkan', 'success');
        }

        function processTransaction() {
            if (cart.length === 0) {
                showNotification('Keranjang masih kosong!', 'error');
                return;
            }

            const discount = parseFloat(document.getElementById('discountInput').value) || 0;
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const total = subtotal - discount;
            const payment = parseFloat(document.getElementById('paymentInput').value) || 0;

            if (payment < total) {
                showNotification('Pembayaran kurang!', 'error');
                return;
            }

            // Update stock
            cart.forEach(item => {
                const product = products.find(p => p.id === item.id);
                if (product) {
                    product.stock -= item.quantity;
                }
            });

            // Create transaction
            const transaction = {
                id: 'TRX' + Date.now(),
                date: new Date().toISOString(),
                items: [...cart],
                subtotal: subtotal,
                discount: discount,
                total: total,
                payment: payment,
                change: payment - total
            };

            transactions.push(transaction);
            saveTransactions();
            saveProducts();

            // Print receipt
            printReceipt(transaction);

            // Clear cart
            cart = [];
            updateCart();
            document.getElementById('paymentInput').value = '';
            document.getElementById('changeOutput').value = '';
            document.getElementById('discountInput').value = '0';

            updateDashboard();
            renderProducts();
            renderProductsTable();
            showNotification('Transaksi berhasil!', 'success');
        }

        // Transactions
        function renderTransactions() {
            const tbody = document.querySelector('#transactionsTable tbody');
            const recentTbody = document.querySelector('#recentTransactionsTable tbody');
            
            const dateFrom = document.getElementById('filterDateFrom')?.value;
            const dateTo = document.getElementById('filterDateTo')?.value;

            let filtered = [...transactions].reverse();

            if (dateFrom && dateTo) {
                filtered = filtered.filter(t => {
                    const transDate = new Date(t.date).toISOString().split('T')[0];
                    return transDate >= dateFrom && transDate <= dateTo;
                });
            }

            const html = filtered.map(trans => `
                <tr>
                    <td>${trans.id}</td>
                    <td>${formatDate(trans.date)}</td>
                    <td>Rp ${formatNumber(trans.total)}</td>
                    <td>Rp ${formatNumber(trans.discount)}</td>
                    <td>Rp ${formatNumber(trans.payment)}</td>
                    <td>Rp ${formatNumber(trans.change)}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="viewTransaction('${trans.id}')">üëÅÔ∏è</button>
                        <button class="btn btn-primary" onclick="printTransaction('${trans.id}')">üñ®Ô∏è</button>
                    </td>
                </tr>
            `).join('');

            tbody.innerHTML = html || '<tr><td colspan="7" style="text-align: center;">Tidak ada transaksi</td></tr>';
            
            // Recent transactions (last 5)
            const recent = [...transactions].reverse().slice(0, 5);
            recentTbody.innerHTML = recent.map(trans => `
                <tr>
                    <td>${trans.id}</td>
                    <td>${formatDate(trans.date)}</td>
                    <td>Rp ${formatNumber(trans.total)}</td>
                    <td>${trans.items.length} items</td>
                    <td>
                        <button class="btn btn-secondary" onclick="viewTransaction('${trans.id}')">üëÅÔ∏è</button>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="5" style="text-align: center;">Belum ada transaksi</td></tr>';
        }

        function filterTransactions() {
            renderTransactions();
        }

        function viewTransaction(id) {
            const trans = transactions.find(t => t.id === id);
            if (!trans) return;

            const detail = `
                <div style="margin-bottom: 15px;">
                    <strong>ID Transaksi:</strong> ${trans.id}<br>
                    <strong>Tanggal:</strong> ${formatDate(trans.date)}
                </div>
                <table style="width: 100%; margin-bottom: 15px;">
                    <thead>
                        <tr>
                            <th>Produk</th>
                            <th>Harga</th>
                            <th>Qty</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${trans.items.map(item => `
                            <tr>
                                <td>${item.name}</td>
                                <td>Rp ${formatNumber(item.price)}</td>
                                <td>${item.quantity}</td>
                                <td>Rp ${formatNumber(item.price * item.quantity)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <div style="text-align: right;">
                    <strong>Subtotal:</strong> Rp ${formatNumber(trans.subtotal)}<br>
                    <strong>Diskon:</strong> Rp ${formatNumber(trans.discount)}<br>
                    <strong>Total:</strong> Rp ${formatNumber(trans.total)}<br>
                    <strong>Bayar:</strong> Rp ${formatNumber(trans.payment)}<br>
                    <strong>Kembali:</strong> Rp ${formatNumber(trans.change)}
                </div>
            `;

            document.getElementById('transactionDetail').innerHTML = detail;
            document.getElementById('transactionModal').classList.add('active');
        }

        function closeTransactionModal() {
            document.getElementById('transactionModal').classList.remove('active');
        }

        function printTransaction(id) {
            const trans = transactions.find(t => t.id === id);
            if (trans) printReceipt(trans);
        }

        function printReceipt(transaction) {
            const printArea = document.getElementById('printArea');
            printArea.innerHTML = `
                <div style="width: 300px; margin: 0 auto; font-family: monospace;">
                    <h2 style="text-align: center;">${settings.storeName}</h2>
                    <p style="text-align: center; font-size: 12px;">
                        ${settings.storeAddress}<br>
                        ${settings.storePhone}
                    </p>
                    <hr>
                    <p>
                        No: ${transaction.id}<br>
                        Tanggal: ${formatDate(transaction.date)}
                    </p>
                    <hr>
                    <table style="width: 100%; font-size: 12px;">
                        ${transaction.items.map(item => `
                            <tr>
                                <td colspan="3">${item.name}</td>
                            </tr>
                            <tr>
                                <td>${item.quantity} x</td>
                                <td>Rp ${formatNumber(item.price)}</td>
                                <td align="right">Rp ${formatNumber(item.price * item.quantity)}</td>
                            </tr>
                        `).join('')}
                    </table>
                    <hr>
                    <table style="width: 100%;">
                        <tr>
                            <td>Subtotal:</td>
                            <td align="right">Rp ${formatNumber(transaction.subtotal)}</td>
                        </tr>
                        <tr>
                            <td>Diskon:</td>
                            <td align="right">Rp ${formatNumber(transaction.discount)}</td>
                        </tr>
                        <tr style="font-weight: bold; font-size: 16px;">
                            <td>TOTAL:</td>
                            <td align="right">Rp ${formatNumber(transaction.total)}</td>
                        </tr>
                        <tr>
                            <td>Bayar:</td>
                            <td align="right">Rp ${formatNumber(transaction.payment)}</td>
                        </tr>
                        <tr>
                            <td>Kembali:</td>
                            <td align="right">Rp ${formatNumber(transaction.change)}</td>
                        </tr>
                    </table>
                    <hr>
                    <p style="text-align: center; font-size: 12px;">
                        Terima Kasih<br>
                        Selamat Berbelanja Kembali
                    </p>
                </div>
            `;
            printArea.style.display = 'block';
            window.print();
            printArea.style.display = 'none';
        }

        // Dashboard & Reports
        function updateDashboard() {
            document.getElementById('totalProducts').textContent = products.length;
            
            const today = new Date().toISOString().split('T')[0];
            const todayTransactions = transactions.filter(t => 
                t.date.split('T')[0] === today
            );
            const todaySales = todayTransactions.reduce((sum, t) => sum + t.total, 0);
            document.getElementById('todaySales').textContent = 'Rp ' + formatNumber(todaySales);

            const lowStockCount = products.filter(p => p.stock <= p.minStock).length;
            document.getElementById('lowStock').textContent = lowStockCount;

            document.getElementById('totalTransactions').textContent = transactions.length;
        }

        function updateReports() {
            // Month sales
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            const monthTransactions = transactions.filter(t => {
                const date = new Date(t.date);
                return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            });
            const monthSales = monthTransactions.reduce((sum, t) => sum + t.total, 0);
            document.getElementById('monthSales').textContent = 'Rp ' + formatNumber(monthSales);

            // Total sales
            const totalSales = transactions.reduce((sum, t) => sum + t.total, 0);
            document.getElementById('totalSales').textContent = 'Rp ' + formatNumber(totalSales);

            // Stock value
            const stockValue = products.reduce((sum, p) => sum + (p.price * p.stock), 0);
            document.getElementById('stockValue').textContent = 'Rp ' + formatNumber(stockValue);

            // Top products
            const productSales = {};
            transactions.forEach(trans => {
                trans.items.forEach(item => {
                    if (!productSales[item.id]) {
                        productSales[item.id] = {
                            name: item.name,
                            quantity: 0,
                            total: 0
                        };
                    }
                    productSales[item.id].quantity += item.quantity;
                    productSales[item.id].total += item.price * item.quantity;
                });
            });

            const topProducts = Object.values(productSales)
                .sort((a, b) => b.quantity - a.quantity)
                .slice(0, 10);

            if (topProducts.length > 0) {
                document.getElementById('topProduct').textContent = topProducts[0].name;
            }

            const tbody = document.querySelector('#topProductsTable tbody');
            tbody.innerHTML = topProducts.map((product, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${product.name}</td>
                    <td>${product.quantity}</td>
                    <td>Rp ${formatNumber(product.total)}</td>
                </tr>
            `).join('') || '<tr><td colspan="4" style="text-align: center;">Belum ada data</td></tr>';
        }

        // Settings
        function loadSettings() {
            document.getElementById('storeName').value = settings.storeName;
            document.getElementById('storeAddress').value = settings.storeAddress;
            document.getElementById('storePhone').value = settings.storePhone;
            document.getElementById('storeEmail').value = settings.storeEmail;
        }

        function saveSettings() {
            settings = {
                storeName: document.getElementById('storeName').value,
                storeAddress: document.getElementById('storeAddress').value,
                storePhone: document.getElementById('storePhone').value,
                storeEmail: document.getElementById('storeEmail').value
            };
            localStorage.setItem('settings', JSON.stringify(settings));
            showNotification('Pengaturan berhasil disimpan', 'success');
        }

        // Data Management
        function saveProducts() {
            localStorage.setItem('products', JSON.stringify(products));
        }

        function saveTransactions() {
            localStorage.setItem('transactions', JSON.stringify(transactions));
        }

        function exportData() {
            const data = {
                products,
                transactions,
                settings,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `kasir-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('Data berhasil diekspor', 'success');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (confirm('Import data akan menimpa data yang ada. Lanjutkan?')) {
                        products = data.products || [];
                        transactions = data.transactions || [];
                        settings = data.settings || settings;
                        
                        saveProducts();
                        saveTransactions();
                        localStorage.setItem('settings', JSON.stringify(settings));
                        
                        updateDashboard();
                        renderProducts();
                        renderProductsTable();
                        renderTransactions();
                        updateReports();
                        loadSettings();
                        
                        showNotification('Data berhasil diimpor', 'success');
                    }
                } catch (error) {
                    showNotification('File tidak valid!', 'error');
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if (!confirm('Yakin ingin menghapus SEMUA data? Tindakan ini tidak dapat dibatalkan!')) return;
            if (!confirm('Apakah Anda benar-benar yakin? Data akan hilang permanen!')) return;
            
            products = [];
            transactions = [];
            cart = [];
            
            localStorage.removeItem('products');
            localStorage.removeItem('transactions');
            
            updateDashboard();
            renderProducts();
            renderProductsTable();
            renderTransactions();
            updateReports();
            updateCart();
            
            showNotification('Semua data berhasil dihapus', 'success');
        }

        function loadSampleData() {
            if (products.length > 0) {
                if (!confirm('Data produk sudah ada. Tetap muat data contoh?')) return;
            }

            const sampleProducts = [
                { code: 'P001', name: 'Indomie Goreng', category: 'Makanan', price: 3000, stock: 100, minStock: 20 },
                { code: 'P002', name: 'Aqua 600ml', category: 'Minuman', price: 4000, stock: 80, minStock: 15 },
                { code: 'P003', name: 'Teh Pucuk', category: 'Minuman', price: 5000, stock: 60, minStock: 10 },
                { code: 'P004', name: 'Chitato', category: 'Snack', price: 8000, stock: 50, minStock: 10 },
                { code: 'P005', name: 'Susu Bendera', category: 'Minuman', price: 15000, stock: 40, minStock: 8 },
                { code: 'P006', name: 'Minyak Goreng 1L', category: 'Sembako', price: 18000, stock: 30, minStock: 5 },
                { code: 'P007', name: 'Beras 5kg', category: 'Sembako', price: 65000, stock: 25, minStock: 5 },
                { code: 'P008', name: 'Gula Pasir 1kg', category: 'Sembako', price: 14000, stock: 35, minStock: 7 },
                { code: 'P009', name: 'Kopi Kapal Api', category: 'Minuman', price: 2500, stock: 90, minStock: 15 },
                { code: 'P010', name: 'Sabun Lifebuoy', category: 'Toiletries', price: 5500, stock: 45, minStock: 10 }
            ];

            products = sampleProducts.map(p => ({
                ...p,
                id: Date.now() + Math.random().toString(),
                createdAt: new Date().toISOString()
            }));

            saveProducts();
            renderProducts();
            renderProductsTable();
            updateDashboard();
            
            showNotification('Data contoh berhasil dimuat', 'success');
        }

        // Utilities
        function formatNumber(num) {
            return new Intl.NumberFormat('id-ID').format(num);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Service Worker for PWA
        const manifest = {
            "name": "Kasir & Stok Barang",
            "short_name": "Kasir App",
            "description": "Aplikasi Kasir dan Manajemen Stok Barang - Offline Ready",
            "start_url": "./kasir-app.html",
            "scope": "./",
            "display": "standalone",
            "orientation": "portrait-primary",
            "background_color": "#4F46E5",
            "theme_color": "#4F46E5",
            "categories": ["business", "finance", "productivity"],
            "icons": [
                {
                    "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect fill='%234F46E5' width='192' height='192' rx='40'/%3E%3Ctext x='96' y='96' font-size='100' text-anchor='middle' dy='.35em'%3Eüè™%3C/text%3E%3C/svg%3E",
                    "sizes": "192x192",
                    "type": "image/svg+xml",
                    "purpose": "any maskable"
                },
                {
                    "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect fill='%234F46E5' width='512' height='512' rx='100'/%3E%3Ctext x='256' y='256' font-size='280' text-anchor='middle' dy='.35em'%3Eüè™%3C/text%3E%3C/svg%3E",
                    "sizes": "512x512",
                    "type": "image/svg+xml",
                    "purpose": "any maskable"
                }
            ]
        };

        // Create manifest blob
        const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.querySelector('link[rel="manifest"]').href = manifestURL;
    </script>
</body>
</html>
